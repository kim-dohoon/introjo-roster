<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›ë£Œìƒì‚°íŒ€ ì„¤ë¹„ìš´ì˜ ê·¼ë¬´ê³„íší‘œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============================================================================
        // [í•„ìˆ˜] 2ë‹¨ê³„: Firebase ì„¤ì •ê°’ ì…ë ¥
        // ============================================================================
        const myFirebaseConfig = {
            apiKey: "AIzaSyBUyDZ2MhXGPXtWqz5F7S0EY4nEjeA1Nys",
            authDomain: "introjo-roster.firebaseapp.com",
            projectId: "introjo-roster",
            storageBucket: "introjo-roster.firebasestorage.app",
            messagingSenderId: "441664828500",
            appId: "1:441664828500:web:566f8c6be0caab1e2469c1"
        };

        const myAppId = 'production-roster-2026';
        // ============================================================================

        const envConfig = JSON.parse(new URLSearchParams(window.location.search).get('__firebase_config') || '{}');
        const firebaseConfig = (Object.keys(myFirebaseConfig).length > 0 && myFirebaseConfig.apiKey) ? myFirebaseConfig : envConfig;
        const appId = (Object.keys(myFirebaseConfig).length > 0 && myFirebaseConfig.apiKey) ? myAppId : 'default-app';

        // [ì¤‘ìš”] ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì • ìƒíƒœ ë…¸ì¶œ (ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ ì ‘ê·¼ìš©)
        window.hasFirebaseConfig = (Object.keys(firebaseConfig).length > 0 && !!firebaseConfig.apiKey);

        let app, auth, db, user;
        window.isFirebaseLoaded = false;

        // ì„¤ì •ê°’ ë¯¸ì…ë ¥ ì‹œ ê²½ê³  í‘œì‹œ í•¨ìˆ˜
        function showConfigWarning() {
            const warningBanner = document.createElement('div');
            warningBanner.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4';
            warningBanner.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl text-center">
                    <h3 class="text-lg font-bold text-gray-900 mb-2">ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!</h3>
                    <p class="text-sm text-gray-500 mb-6">Firebase ì„¤ì •ê°’ì„ ì½”ë“œì— ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 text-white py-2 rounded">ë‹«ê¸°</button>
                </div>
            `;
            document.body.appendChild(warningBanner);
        }

        if (!window.hasFirebaseConfig) {
            setTimeout(showConfigWarning, 1000);
        } else {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                signInAnonymously(auth).catch((e) => console.warn("Auth failed:", e));

                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        initRealtimeListeners();
                    }
                });
            } catch (e) {
                console.warn("Firebase init failed:", e);
            }
        }

        // --- Data Management (Multi-month support) ---
        window.rosterData = {};
        window.configLoaded = false;
        let unsubscribes = [];
        let configUnsubscribes = [];

        // Load config from Firebase
        async function loadConfigFromFirebase() {
            if (!db) return;

            try {
                // Load all config documents
                const holidaysSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'config', 'holidays'));
                const teamMembersSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'config', 'teamMembers'));
                const shiftTypesSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'config', 'shiftTypes'));
                const attendanceOptionsSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'config', 'attendanceOptions'));
                const systemSettingsSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'config', 'systemSettings'));

                // Update global variables with Firebase config data
                if (holidaysSnap.exists()) {
                    const holidaysData = holidaysSnap.data();
                    // Flatten year-based structure into single object
                    window.HOLIDAYS = {};
                    Object.keys(holidaysData).forEach(year => {
                        Object.assign(window.HOLIDAYS, holidaysData[year]);
                    });
                }

                if (teamMembersSnap.exists()) {
                    window.TEAM_MEMBERS = teamMembersSnap.data();
                }

                if (shiftTypesSnap.exists()) {
                    window.SHIFT_TYPES = shiftTypesSnap.data();
                }

                if (attendanceOptionsSnap.exists()) {
                    const data = attendanceOptionsSnap.data();
                    window.ATTENDANCE_OPTIONS = data.options || window.ATTENDANCE_OPTIONS;
                }

                if (systemSettingsSnap.exists()) {
                    const settings = systemSettingsSnap.data();
                    if (settings.baseDate) {
                        const parts = settings.baseDate.split('-');
                        window.BASE_DATE = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    }
                    if (settings.shiftWorkHours) window.SHIFT_WORK_HOURS = settings.shiftWorkHours;
                    if (settings.dayWorkHours) window.DAY_WORK_HOURS = settings.dayWorkHours;
                }

                window.configLoaded = true;
                console.log('âœ… Config loaded from Firebase');
                if (window.renderCalendar) window.renderCalendar();
            } catch (error) {
                console.error('Config load failed:', error);
            }
        }

        function initRealtimeListeners() {
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];

            // Load config first
            if (!window.configLoaded) {
                loadConfigFromFirebase();
            }

            const currentY = window.currentYear || 2026;
            const currentM = window.currentMonth || 0;

            const monthsToSubscribe = [
                new Date(currentY, currentM - 1, 1),
                new Date(currentY, currentM, 1),
                new Date(currentY, currentM + 1, 1)
            ];

            monthsToSubscribe.forEach(d => {
                const docId = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', docId);

                const unsub = onSnapshot(docRef, (snapshot) => {
                    window.isFirebaseLoaded = true;
                    if (snapshot.exists()) {
                        window.rosterData[docId] = snapshot.data();
                    } else {
                        window.rosterData[docId] = {};
                    }

                    const liveBadge = document.getElementById('liveBadge');
                    if (liveBadge) liveBadge.classList.remove('hidden');

                    if (window.renderCalendar) window.renderCalendar();
                }, (error) => console.error(`Sync error (${docId}):`, error));

                unsubscribes.push(unsub);
            });
        }

        // --- Save Logic ---
        let saveTimeout;
        let pendingChanges = {};

        window.saveToDb = (key, value) => {
            const parts = key.split('_');
            let dateStr = '';
            if (parts[1] === 'ot' || parts[1] === 'type') dateStr = parts[3];
            else dateStr = parts[2];
            const monthKey = dateStr.substring(0, 7);

            if (!window.rosterData[monthKey]) window.rosterData[monthKey] = {};
            window.rosterData[monthKey][key] = value;

            if (!pendingChanges[monthKey]) pendingChanges[monthKey] = {};
            pendingChanges[monthKey][key] = value;

            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.style.opacity = '1';
                syncStatus.innerHTML = `<span class="animate-spin mr-1">â†»</span> ì €ì¥ ì¤‘...`;
            }

            if (!user) return;

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const updatesByMonth = { ...pendingChanges };
                pendingChanges = {};

                try {
                    const promises = Object.keys(updatesByMonth).map(mKey => {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', mKey);
                        return setDoc(docRef, updatesByMonth[mKey], { merge: true });
                    });

                    await Promise.all(promises);

                    if (syncStatus) {
                        syncStatus.innerHTML = `<span>âœ“</span> ì €ì¥ ì™„ë£Œ`;
                        setTimeout(() => {
                            if (Object.keys(pendingChanges).length === 0) syncStatus.style.opacity = '0';
                        }, 800);
                    }
                } catch (e) {
                    console.error("Save failed:", e);
                    if (syncStatus) syncStatus.innerText = "ì €ì¥ ì‹¤íŒ¨";
                }
            }, 500);
        };

        window.changeMonthListener = () => {
            if (user) initRealtimeListeners();
        };

        window.getDbData = (key) => {
            const parts = key.split('_');
            let dateStr = '';
            if (parts[1] === 'ot' || parts[1] === 'type') dateStr = parts[3];
            else dateStr = parts[2];
            const monthKey = dateStr.substring(0, 7);
            return window.rosterData[monthKey] && window.rosterData[monthKey][key]
                ? window.rosterData[monthKey][key]
                : '';
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans KR', 'sans-serif'] },
                    colors: { primary: '#4f46e5', secondary: '#64748b', bg: '#f8fafc' },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f1f5f9;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
            border-radius: 0 0 0.75rem 0.75rem;
            overflow: hidden;
        }

        .calendar-day {
            min-height: 110px;
            background-color: white;
            transition: background-color 0.2s;
        }

        .calendar-day:hover {
            background-color: #f8fafc;
        }

        .horizontal-scroll-container {
            display: flex;
            overflow-x: auto;
            padding: 0.5rem;
            gap: 0.25rem;
            scroll-behavior: smooth;
            align-items: stretch;
        }

        .horizontal-scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .horizontal-scroll-container::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }

        .horizontal-scroll-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }

        .horizontal-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .day-card {
            flex: 0 0 160px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .detail-card {
            flex: 0 0 160px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            border-top: 3px solid #6366f1;
        }

        .summary-card {
            flex: 0 0 140px;
            background-color: white;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .date-box {
            width: 100%;
            height: 50px;
            display: flex;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .tab-container {
            background-color: #f1f5f9;
            padding: 0.25rem;
            border-radius: 0.75rem;
            display: flex;
        }

        .main-tab {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .main-tab.active {
            background-color: white;
            color: #4f46e5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .main-tab.inactive:hover {
            color: #334155;
            background-color: rgba(255, 255, 255, 0.5);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(2px);
        }
    </style>
</head>

<body class="text-slate-700 antialiased">

    <div class="max-w-[1400px] mx-auto p-4 md:p-6 relative">
        <!-- Live Status Badges -->
        <div class="fixed top-4 right-4 z-50 flex flex-col gap-2 items-end">
            <div id="liveBadge"
                class="hidden flex items-center bg-white/90 backdrop-blur px-2.5 py-1 rounded-full shadow-md border border-emerald-100 text-[10px] font-bold text-emerald-600 transition-all">
                <span class="relative flex h-2 w-2 mr-1.5"><span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span
                        class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span>LIVE
            </div>
            <div id="syncStatus"
                class="flex items-center bg-indigo-600 px-2.5 py-1 rounded-full shadow-md text-[10px] font-medium text-white opacity-0 transition-opacity duration-300">
                <svg class="animate-spin -ml-0.5 mr-1.5 h-2.5 w-2.5 text-white" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>ì €ì¥ ì¤‘...
            </div>
        </div>

        <!-- Header -->
        <header class="mb-6 flex flex-col md:flex-row items-center justify-between relative gap-4">
            <h1
                class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-500 tracking-tight">
                ì›ë£Œìƒì‚°íŒ€ ì„¤ë¹„ìš´ì˜ ê·¼ë¬´ê³„íší‘œ
            </h1>
            <button onclick="downloadAllData()"
                class="flex items-center gap-2 px-4 py-2 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 font-semibold text-sm rounded-lg border border-emerald-200 transition-all shadow-sm hover:shadow-md">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                ë°ì´í„° ë‹¤ìš´ë¡œë“œ
            </button>
        </header>

        <!-- Main Controls -->
        <div class="bg-white rounded-xl shadow-soft p-1 mb-6 border border-slate-100">
            <div class="tab-container mb-4 mx-4 mt-4 max-w-2xl lg:mx-6">
                <button id="tab-CALENDAR" onclick="switchMainTab('CALENDAR')" class="main-tab active"><span
                        class="mr-1">ğŸ“…</span>ì›”ê°„ ìº˜ë¦°ë”</button>
                <button id="tab-TEAM" onclick="switchMainTab('TEAM')" class="main-tab inactive"><span
                        class="mr-1">âœï¸</span>ê·¼ë¬´ì¡°ë³„ ì…ë ¥</button>
                <button id="tab-DETAIL" onclick="switchMainTab('DETAIL')" class="main-tab inactive"><span
                        class="mr-1">ğŸ”</span>ì „ì²´ ìƒì„¸</button>
            </div>
            <div class="px-6 pb-4 pt-2">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <!-- Date -->
                    <div class="md:col-span-2">
                        <label
                            class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Date</label>
                        <div class="flex space-x-2">
                            <select id="yearSelect"
                                class="block w-full pl-2 pr-6 py-1.5 text-xs font-semibold bg-slate-50 border border-slate-200 rounded-md focus:ring-1 focus:ring-indigo-500 cursor-pointer">
                                <option value="2025">2025ë…„</option>
                                <option value="2026" selected>2026ë…„</option>
                                <option value="2027">2027ë…„</option>
                                <option value="2028">2028ë…„</option>
                                <option value="2029">2029ë…„</option>
                                <option value="2030">2030ë…„</option>
                            </select>
                            <select id="monthSelect"
                                class="block w-full pl-2 pr-6 py-1.5 text-xs font-semibold bg-slate-50 border border-slate-200 rounded-md focus:ring-1 focus:ring-indigo-500 cursor-pointer"></select>
                        </div>
                    </div>
                    <!-- Nav -->
                    <div class="md:col-span-2 flex justify-start gap-1">
                        <button onclick="changeMonth(-1)"
                            class="p-1.5 bg-white border border-slate-200 hover:bg-slate-50 rounded text-slate-600 transition-colors shadow-sm"><i
                                data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <button onclick="changeMonth(1)"
                            class="p-1.5 bg-indigo-600 hover:bg-indigo-700 rounded text-white shadow-md shadow-indigo-200 transition-colors"><i
                                data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                    <!-- Pattern -->
                    <div class="md:col-span-3">
                        <label
                            class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Pattern</label>
                        <select id="cycleType" onchange="renderCalendar()"
                            class="block w-full pl-2 pr-6 py-1.5 text-xs bg-slate-50 border border-slate-200 rounded-md focus:ring-1 focus:ring-indigo-500 cursor-pointer">
                            <option value="3" selected>4ê·¼ë¬´ 2íœ´ë¬´ (ì£¼4-íœ´2-ì•¼4-íœ´2)</option>
                            <option value="2">2ê·¼ë¬´ 2íœ´ë¬´ (ì£¼ì£¼-ì•¼ì•¼-ë¹„ë¹„)</option>
                            <option value="1">2ê·¼ë¬´ 1íœ´ë¬´ (ì£¼-ì•¼-ë¹„)</option>
                        </select>
                    </div>
                    <!-- Team -->
                    <div id="teamSelectContainer" class="hidden md:col-span-5">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Team
                            Select</label>
                        <div class="flex bg-slate-100 p-0.5 rounded-md">
                            <button onclick="setTeamFilter('A')" id="btn-A"
                                class="flex-1 py-1 text-xs font-medium rounded transition-all">Aì¡°</button>
                            <button onclick="setTeamFilter('B')" id="btn-B"
                                class="flex-1 py-1 text-xs font-medium rounded transition-all">Bì¡°</button>
                            <button onclick="setTeamFilter('C')" id="btn-C"
                                class="flex-1 py-1 text-xs font-medium rounded transition-all">Cì¡°</button>
                            <button onclick="setTeamFilter('DAY_ONLY')" id="btn-DAY_ONLY"
                                class="flex-1 py-1 text-xs font-medium rounded transition-all">ì£¼ê°„</button>
                        </div>
                    </div>
                    <div id="teamSelectPlaceholder" class="hidden md:block md:col-span-5"></div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="flex flex-wrap justify-center gap-4 mb-4">
            <div class="flex items-center text-xs font-medium text-slate-600"><span
                    class="w-2.5 h-2.5 rounded-full bg-amber-400 mr-1.5 shadow-sm"></span>ì£¼ê°„</div>
            <div class="flex items-center text-xs font-medium text-slate-600"><span
                    class="w-2.5 h-2.5 rounded-full bg-indigo-500 mr-1.5 shadow-sm"></span>ì•¼ê°„</div>
            <div class="flex items-center text-xs font-medium text-slate-600"><span
                    class="w-2.5 h-2.5 rounded-full bg-emerald-400 mr-1.5 shadow-sm"></span>ì£¼íœ´(ì´ˆë¡)</div>
            <div class="flex items-center text-xs font-medium text-slate-600"><span
                    class="w-2.5 h-2.5 rounded-full bg-slate-400 mr-1.5 shadow-sm"></span>ë¬´íœ´(íšŒìƒ‰)</div>
            <div class="flex items-center text-xs font-medium text-slate-600"><span
                    class="w-2.5 h-2.5 rounded-full bg-red-400 mr-1.5 shadow-sm"></span>ìœ íœ´(ê³µíœ´)</div>
        </div>

        <!-- View Container -->
        <div class="bg-white rounded-xl shadow-soft overflow-hidden border border-slate-200 relative min-h-[400px]">
            <div id="loadingOverlay" class="loading-overlay hidden">
                <div class="flex flex-col items-center">
                    <svg class="animate-spin h-6 w-6 text-indigo-600 mb-2" xmlns="http://www.w3.org/2000/svg"
                        fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span class="text-xs font-medium text-slate-500">ë¡œë”©ì¤‘...</span>
                </div>
            </div>
            <div id="gridHeader" class="grid grid-cols-7 bg-slate-50 border-b border-slate-200 hidden">
                <div class="py-3 text-center text-red-500 font-bold text-xs">SUN</div>
                <div class="py-3 text-center text-slate-600 font-bold text-xs">MON</div>
                <div class="py-3 text-center text-slate-600 font-bold text-xs">TUE</div>
                <div class="py-3 text-center text-slate-600 font-bold text-xs">WED</div>
                <div class="py-3 text-center text-slate-600 font-bold text-xs">THU</div>
                <div class="py-3 text-center text-slate-600 font-bold text-xs">FRI</div>
                <div class="py-3 text-center text-blue-500 font-bold text-xs">SAT</div>
            </div>
            <div id="calendar" class="min-h-[400px]"></div>
        </div>

        <p id="scrollHint" class="text-center text-xs text-slate-400 mt-2 font-medium hidden">
            <span class="inline-block animate-pulse">â† ì¢Œìš° ìŠ¤í¬ë¡¤ â†’</span>
        </p>
    </div>

    <script>
        window.dbState = {};
        let currentYear = 2026;
        let currentMonth = 0;
        let viewMode = 'CALENDAR';
        let currentTeam = 'A';

        // Config variables - will be loaded from Firebase
        window.BASE_DATE = new Date(2026, 0, 1);
        window.SHIFT_WORK_HOURS = 10.25;
        window.DAY_WORK_HOURS = 8.0;

        // Holidays - loaded from Firebase, fallback data
        window.HOLIDAYS = {
            '2025-01-01': 'ì‹ ì •', '2025-01-28': 'ì„¤ë‚ ', '2025-01-29': 'ì„¤ë‚ ', '2025-01-30': 'ì„¤ë‚ ', '2025-03-01': 'ì‚¼ì¼ì ˆ', '2025-03-03': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-05-05': 'ì–´ë¦°ì´ë‚ ', '2025-05-06': 'ëŒ€ì²´ê³µíœ´ì¼', '2025-06-06': 'í˜„ì¶©ì¼', '2025-08-15': 'ê´‘ë³µì ˆ', '2025-10-03': 'ê°œì²œì ˆ',
            '2025-10-05': 'ì¶”ì„', '2025-10-06': 'ì¶”ì„', '2025-10-07': 'ì¶”ì„', '2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼', '2025-10-09': 'í•œê¸€ë‚ ', '2025-12-25': 'ì„±íƒ„ì ˆ',
            '2026-01-01': 'ì‹ ì •', '2026-02-16': 'ì„¤ë‚ ', '2026-02-17': 'ì„¤ë‚ ', '2026-02-18': 'ì„¤ë‚ ', '2026-03-01': 'ì‚¼ì¼ì ˆ', '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-05-05': 'ì–´ë¦°ì´ë‚ ', '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-06-06': 'í˜„ì¶©ì¼', '2026-08-15': 'ê´‘ë³µì ˆ', '2026-08-17': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-09-24': 'ì¶”ì„', '2026-09-25': 'ì¶”ì„', '2026-09-26': 'ì¶”ì„', '2026-10-03': 'ê°œì²œì ˆ', '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-10-09': 'í•œê¸€ë‚ ',
            '2026-12-25': 'ì„±íƒ„ì ˆ',
            '2027-01-01': 'ì‹ ì •', '2027-02-06': 'ì„¤ë‚ ', '2027-02-07': 'ì„¤ë‚ ', '2027-02-08': 'ì„¤ë‚ ', '2027-02-09': 'ëŒ€ì²´ê³µíœ´ì¼', '2027-03-01': 'ì‚¼ì¼ì ˆ',
            '2027-05-05': 'ì–´ë¦°ì´ë‚ ', '2027-05-13': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2027-06-06': 'í˜„ì¶©ì¼', '2027-08-15': 'ê´‘ë³µì ˆ', '2027-08-16': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2027-09-14': 'ì¶”ì„', '2027-09-15': 'ì¶”ì„', '2027-09-16': 'ì¶”ì„', '2027-10-03': 'ê°œì²œì ˆ', '2027-10-04': 'ëŒ€ì²´ê³µíœ´ì¼', '2027-10-09': 'í•œê¸€ë‚ ', '2027-10-11': 'ëŒ€ì²´ê³µíœ´ì¼', '2027-12-25': 'ì„±íƒ„ì ˆ', '2027-12-27': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2028-01-01': 'ì‹ ì •', '2028-01-26': 'ì„¤ë‚ ', '2028-01-27': 'ì„¤ë‚ ', '2028-01-28': 'ì„¤ë‚ ', '2028-03-01': 'ì‚¼ì¼ì ˆ', '2028-05-02': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2028-05-05': 'ì–´ë¦°ì´ë‚ ',
            '2028-06-06': 'í˜„ì¶©ì¼', '2028-08-15': 'ê´‘ë³µì ˆ', '2028-10-02': 'ì¶”ì„', '2028-10-03': 'ì¶”ì„', '2028-10-04': 'ì¶”ì„', '2028-10-05': 'ëŒ€ì²´ê³µíœ´ì¼', '2028-10-09': 'í•œê¸€ë‚ ', '2028-12-25': 'ì„±íƒ„ì ˆ',
            '2029-01-01': 'ì‹ ì •', '2029-02-12': 'ì„¤ë‚ ', '2029-02-13': 'ì„¤ë‚ ', '2029-02-14': 'ì„¤ë‚ ', '2029-03-01': 'ì‚¼ì¼ì ˆ', '2029-05-05': 'ì–´ë¦°ì´ë‚ ', '2029-05-07': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2029-05-20': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2029-05-21': 'ëŒ€ì²´ê³µíœ´ì¼', '2029-06-06': 'í˜„ì¶©ì¼', '2029-08-15': 'ê´‘ë³µì ˆ', '2029-09-21': 'ì¶”ì„', '2029-09-22': 'ì¶”ì„', '2029-09-23': 'ì¶”ì„', '2029-09-24': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2029-10-03': 'ê°œì²œì ˆ', '2029-10-09': 'í•œê¸€ë‚ ', '2029-12-25': 'ì„±íƒ„ì ˆ',
            '2030-01-01': 'ì‹ ì •', '2030-02-02': 'ì„¤ë‚ ', '2030-02-03': 'ì„¤ë‚ ', '2030-02-04': 'ì„¤ë‚ ', '2030-02-05': 'ëŒ€ì²´ê³µíœ´ì¼', '2030-03-01': 'ì‚¼ì¼ì ˆ', '2030-05-05': 'ì–´ë¦°ì´ë‚ ', '2030-05-06': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2030-05-09': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2030-06-06': 'í˜„ì¶©ì¼', '2030-08-15': 'ê´‘ë³µì ˆ', '2030-09-11': 'ì¶”ì„', '2030-09-12': 'ì¶”ì„', '2030-09-13': 'ì¶”ì„', '2030-10-03': 'ê°œì²œì ˆ', '2030-10-09': 'í•œê¸€ë‚ ', '2030-12-25': 'ì„±íƒ„ì ˆ'
        };

        // Shift types - loaded from Firebase, fallback data
        window.SHIFT_TYPES = {
            DAY: { label: 'ì£¼ê°„', color: 'bg-amber-50 text-amber-700', border: 'border-amber-200', badge: 'bg-amber-100 text-amber-800 ring-1 ring-amber-200' },
            NIGHT: { label: 'ì•¼ê°„', color: 'bg-indigo-50 text-indigo-700', border: 'border-indigo-200', badge: 'bg-indigo-100 text-indigo-800 ring-1 ring-indigo-200' },
            JU_HYU: { label: 'ë¬´íœ´', color: 'bg-slate-50 text-slate-500', border: 'border-slate-200', badge: 'bg-slate-100 text-slate-600 ring-1 ring-slate-200' },
            MU_HYU: { label: 'ì£¼íœ´', color: 'bg-emerald-50 text-emerald-700', border: 'border-emerald-200', badge: 'bg-emerald-100 text-emerald-800 ring-1 ring-emerald-200' },
            YU_HYU: { label: 'ìœ íœ´', color: 'bg-red-50 text-red-700', border: 'border-red-200', badge: 'bg-red-100 text-red-800 ring-1 ring-red-200' }
        };

        // Attendance options - loaded from Firebase, fallback data
        window.ATTENDANCE_OPTIONS = [
            { value: '', label: 'ì •ìƒ', color: 'text-slate-500' },
            { value: 'ì—°ì°¨', label: 'ì—°ì°¨', color: 'text-red-500 font-bold' },
            { value: 'ë°˜ì°¨', label: 'ë°˜ì°¨', color: 'text-blue-500 font-bold' },
            { value: 'ì¡°í‡´', label: 'ì¡°í‡´', color: 'text-yellow-600 font-bold' },
            { value: 'ì§€ê°', label: 'ì§€ê°', color: 'text-purple-500 font-bold' },
            { value: 'êµìœ¡', label: 'êµìœ¡', color: 'text-green-600 font-bold' },
            { value: 'í›ˆë ¨', label: 'í›ˆë ¨', color: 'text-indigo-600 font-bold' },
            { value: 'íŠ¹ê·¼', label: 'íŠ¹ê·¼', color: 'text-pink-600 font-bold' },
            { value: 'ê¸°íƒ€', label: 'ê¸°íƒ€', color: 'text-gray-600 font-bold' }
        ];

        window.TEAM_MEMBERS = {
            'A': ['ë°•ì˜ë‚¨', 'í™ì„±ë¯¼', 'ê¹€ì •êµ­', 'ê¹€ë„í›ˆ2', 'ì´ë¯¼ì •', 'ì¡°ëª…ì£¼', ''],
            'B': ['ì˜¤ì˜ì„', 'ì´ë™ì›…', 'ê¹€ìœ¤ìˆ˜', 'ì£¼ì •í˜¸', 'ë°•ì†Œí¬', 'ì¡°ë¯¸í˜•', 'ì†¡ë³´ë€'],
            'C': ['ì •ì¸ì² ', 'ê¹€ë„ì˜', 'ì´ì€í˜', 'ìµœìš©', 'ì „ìˆ˜ì§„', 'ê¹€ì§€í˜œ2', ''],
            'DAY_ONLY': ['ì‹ í™”ë™', 'ì„í˜„ê·œ', 'ê¹€ë¯¼ì†”', '']
        };

        const DAY_NAMES = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        function getDbValue(key) {
            const parts = key.split('_');
            let dateStr = '';
            if (parts[1] === 'ot' || parts[1] === 'type') dateStr = parts[3];
            else dateStr = parts[2];
            const monthKey = dateStr.substring(0, 7);

            if (window.rosterData[monthKey] && window.rosterData[monthKey].hasOwnProperty(key)) {
                return window.rosterData[monthKey][key];
            }
            return undefined;
        }

        function init() {
            lucide.createIcons();
            const monthSelect = document.getElementById('monthSelect');
            for (let i = 0; i < 12; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = `${i + 1}ì›”`;
                monthSelect.appendChild(opt);
            }

            document.getElementById('yearSelect').addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                window.currentYear = currentYear;
                if (window.changeMonthListener) window.changeMonthListener();
                renderCalendar();
            });

            monthSelect.addEventListener('change', (e) => {
                currentMonth = parseInt(e.target.value);
                window.currentMonth = currentMonth;
                if (window.changeMonthListener) window.changeMonthListener();
                renderCalendar();
            });

            window.currentYear = currentYear;
            window.currentMonth = currentMonth;
            window.renderCalendar = renderCalendar;

            switchMainTab('CALENDAR');
        }

        function switchMainTab(mode) {
            viewMode = mode;

            ['CALENDAR', 'TEAM', 'DETAIL'].forEach(m => {
                const tab = document.getElementById(`tab-${m}`);
                if (m === mode) {
                    tab.className = "main-tab active";
                } else {
                    tab.className = "main-tab inactive";
                }
            });

            const teamSelect = document.getElementById('teamSelectContainer');
            const placeholder = document.getElementById('teamSelectPlaceholder');

            if (mode === 'TEAM') {
                teamSelect.classList.remove('hidden');
                placeholder.classList.add('hidden');
                updateTeamButtons();
            } else {
                teamSelect.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }

            renderCalendar();
        }

        function setTeamFilter(team) {
            currentTeam = team;
            updateTeamButtons();
            renderCalendar();
        }

        function updateTeamButtons() {
            ['A', 'B', 'C', 'DAY_ONLY'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                if (t === currentTeam) {
                    btn.className = "flex-1 py-1 text-xs font-bold rounded-md transition-all bg-white text-indigo-600 shadow-sm border border-slate-200";
                } else {
                    btn.className = "flex-1 py-1 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50";
                }
            });
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
                const yearSelect = document.getElementById('yearSelect');
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                    yearSelect.value = currentYear;
                }
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
                const yearSelect = document.getElementById('yearSelect');
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                    yearSelect.value = currentYear;
                }
            }
            document.getElementById('monthSelect').value = currentMonth;

            window.currentYear = currentYear;
            window.currentMonth = currentMonth;

            if (window.changeMonthListener) window.changeMonthListener();

            renderCalendar();
        }

        function getHolidayName(dateStr) {
            return HOLIDAYS[dateStr] || null;
        }

        function getShiftForDate(date) {
            const cycleType = document.getElementById('cycleType').value;
            const diffTime = date.getTime() - BASE_DATE.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            const dateStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            const isHoliday = !!HOLIDAYS[dateStr];

            let shifts = { A: null, B: null, C: null, DAY_ONLY: null };

            if (cycleType === '1') {
                const cIndex = ((diffDays + 0) % 3 + 3) % 3;
                const bIndex = ((diffDays + 1) % 3 + 3) % 3;
                const aIndex = ((diffDays + 2) % 3 + 3) % 3;
                const getShift = (idx) => {
                    if (idx === 0) return window.SHIFT_TYPES.DAY;
                    if (idx === 1) return window.SHIFT_TYPES.NIGHT;
                    return window.SHIFT_TYPES.JU_HYU;
                };
                shifts.C = getShift(cIndex);
                shifts.B = getShift(bIndex);
                shifts.A = getShift(aIndex);
            } else if (cycleType === '2') {
                shifts.A = getShiftFrom6DayCycle(((diffDays + 5) % 6 + 6) % 6);
                shifts.C = getShiftFrom6DayCycle(((diffDays + 1) % 6 + 6) % 6);
                shifts.B = getShiftFrom6DayCycle(((diffDays + 3) % 6 + 6) % 6);
            } else if (cycleType === '3') {
                shifts.A = getShiftFrom12DayCycle(((diffDays + 11) % 12 + 12) % 12);
                shifts.B = getShiftFrom12DayCycle(((diffDays + 7) % 12 + 12) % 12);
                shifts.C = getShiftFrom12DayCycle(((diffDays + 3) % 12 + 12) % 12);
            }

            const dayOfWeek = date.getDay();

            if (isHoliday) {
                shifts.DAY_ONLY = SHIFT_TYPES.YU_HYU;
            } else {
                if (dayOfWeek === 0) shifts.DAY_ONLY = SHIFT_TYPES.MU_HYU;
                else if (dayOfWeek === 6) shifts.DAY_ONLY = SHIFT_TYPES.JU_HYU;
                else shifts.DAY_ONLY = SHIFT_TYPES.DAY;
            }

            return shifts;
        }

        function getShiftFrom6DayCycle(index) {
            if (index === 0 || index === 1) return SHIFT_TYPES.DAY;
            if (index === 2 || index === 3) return SHIFT_TYPES.NIGHT;
            if (index === 4) return SHIFT_TYPES.JU_HYU;
            return SHIFT_TYPES.MU_HYU;
        }

        function getShiftFrom12DayCycle(index) {
            if (index >= 0 && index <= 3) return SHIFT_TYPES.DAY;
            if (index >= 6 && index <= 9) return SHIFT_TYPES.NIGHT;
            if (index === 4 || index === 10) return SHIFT_TYPES.JU_HYU;
            if (index === 5 || index === 11) return SHIFT_TYPES.MU_HYU;
            return SHIFT_TYPES.MU_HYU;
        }

        function calculateWeeklyWorkerStats(sundayDate, targetTeam) {
            const memberCount = (targetTeam === 'DAY_ONLY') ? 4 : 7;
            const slots = [];
            for (let k = 0; k < memberCount; k++) slots.push({ name: '', hours: 0 });

            for (let i = 6; i >= 0; i--) {
                const d = new Date(sundayDate);
                d.setDate(d.getDate() - i);
                const dateStr = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;

                let dailyBaseHours = 0;

                if (targetTeam === 'DAY_ONLY') {
                    if (HOLIDAYS[dateStr]) {
                        dailyBaseHours = 0;
                    } else {
                        const dayOfWeek = d.getDay();
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            dailyBaseHours = 7.5;
                        } else {
                            dailyBaseHours = window.DAY_WORK_HOURS;
                        }
                    }
                } else {
                    dailyBaseHours = window.SHIFT_WORK_HOURS;
                }

                for (let slot = 0; slot < memberCount; slot++) {
                    const nameVal = getMemo(dateStr, slot, targetTeam);
                    const name = typeof nameVal === 'string' ? nameVal.trim() : '';
                    const ot = parseFloat(getMemoOT(dateStr, slot, targetTeam)) || 0;

                    if (name) {
                        slots[slot].name = name;
                        slots[slot].hours += dailyBaseHours + ot;
                    }
                }
            }
            return slots;
        }

        function saveMemo(dateStr, index, value, team) {
            const targetTeam = team || currentTeam;
            const key = `memo_${targetTeam}_${dateStr}_${index}`;
            if (window.saveToDb) window.saveToDb(key, value);
            else if (!window.dbState) { window.dbState = {}; window.dbState[key] = value; }
            updateAllSummaries();
        }

        function getMemo(dateStr, index, team) {
            const targetTeam = team || currentTeam;
            const key = `memo_${targetTeam}_${dateStr}_${index}`;

            const dbVal = getDbValue(key);
            if (dbVal !== undefined) return dbVal;

            if (window.TEAM_MEMBERS[targetTeam] && window.TEAM_MEMBERS[targetTeam][index]) {
                const [y, m, d] = dateStr.split('-').map(Number);
                const date = new Date(y, m - 1, d);
                const shifts = getShiftForDate(date);
                const myShift = shifts[targetTeam];

                if (myShift === window.SHIFT_TYPES.JU_HYU || myShift === window.SHIFT_TYPES.MU_HYU || myShift === window.SHIFT_TYPES.YU_HYU) {
                    return '';
                }
                return window.TEAM_MEMBERS[targetTeam][index];
            }
            return '';
        }

        function saveMemoType(dateStr, index, value, team) {
            const targetTeam = team || currentTeam;
            const typeKey = `memo_type_${targetTeam}_${dateStr}_${index}`;
            const nameKey = `memo_${targetTeam}_${dateStr}_${index}`;

            if (window.saveToDb) window.saveToDb(typeKey, value);

            const [y, m, d] = dateStr.split('-').map(Number);
            const date = new Date(y, m - 1, d);
            const shifts = getShiftForDate(date);
            const myShift = shifts[targetTeam];
            const isOffDay = (myShift === window.SHIFT_TYPES.JU_HYU || myShift === window.SHIFT_TYPES.MU_HYU || myShift === window.SHIFT_TYPES.YU_HYU);

            const defaultName = window.TEAM_MEMBERS[targetTeam] && window.TEAM_MEMBERS[targetTeam][index] ? window.TEAM_MEMBERS[targetTeam][index] : '';

            if (value === 'ì—°ì°¨') {
                if (window.saveToDb) window.saveToDb(nameKey, '');
            } else if (value === 'íŠ¹ê·¼') {
                if (window.saveToDb) window.saveToDb(nameKey, defaultName);
            } else if (value === '') {
                if (isOffDay) {
                    if (window.saveToDb) window.saveToDb(nameKey, '');
                } else {
                    if (window.saveToDb) window.saveToDb(nameKey, defaultName);
                }
            } else {
                if (window.saveToDb) window.saveToDb(nameKey, defaultName);
            }

            renderCalendar();
        }

        function getMemoType(dateStr, index, team) {
            const targetTeam = team || currentTeam;
            const key = `memo_type_${targetTeam}_${dateStr}_${index}`;
            const val = getDbValue(key);
            return val === undefined ? '' : val;
        }

        function saveMemoOT(dateStr, index, value, team) {
            const targetTeam = team || currentTeam;
            const key = `memo_ot_${targetTeam}_${dateStr}_${index}`;
            if (window.saveToDb) window.saveToDb(key, value);
            updateAllSummaries();
        }

        function getMemoOT(dateStr, index, team) {
            const targetTeam = team || currentTeam;
            const key = `memo_ot_${targetTeam}_${dateStr}_${index}`;
            return getDbValue(key);
        }

        function updateAllSummaries() {
            const summaryCards = document.querySelectorAll('.summary-container');
            summaryCards.forEach(card => {
                const sundayDateStr = card.dataset.sunday;
                const sundayDate = new Date(sundayDateStr);
                const contentDiv = card.querySelector('.summary-content');

                if (viewMode === 'DETAIL') {
                    let combinedHtml = '';
                    ['A', 'B', 'C', 'DAY_ONLY'].forEach(team => {
                        const slots = calculateWeeklyWorkerStats(sundayDate, team);
                        const teamName = team === 'DAY_ONLY' ? 'ì£¼ê°„' : team + 'ì¡°';
                        combinedHtml += `
                            <div class="mb-1">
                                <div class="font-bold text-[10px] text-slate-500 uppercase tracking-wider mb-0.5 flex items-center">
                                    <span class="w-1 h-1 rounded-full bg-slate-400 mr-1"></span>
                                    ${teamName}
                                </div>
                                ${generateSummaryHTML(slots)}
                            </div>`;
                    });
                    contentDiv.innerHTML = combinedHtml;
                } else if (viewMode === 'TEAM') {
                    const slots = calculateWeeklyWorkerStats(sundayDate, currentTeam);
                    contentDiv.innerHTML = generateSummaryHTML(slots);
                }
            });
        }

        function generateSummaryHTML(workerList) {
            let html = `<div class="grid grid-cols-1 gap-1">`;
            workerList.forEach(worker => {
                const name = worker.name || '';
                if (!name) {
                    html += `
                        <div class="flex justify-between items-center px-2 h-6 rounded border border-dashed border-slate-200 bg-slate-50/50">
                            <span class="text-xs text-slate-300">-</span>
                        </div>
                    `;
                } else {
                    const hours = worker.hours;
                    const isOvertime = hours > 52;
                    const hoursClass = isOvertime ? "text-rose-600 font-bold" : "text-slate-700 font-semibold";
                    const bgClass = isOvertime ? "bg-rose-50 border-rose-100" : "bg-white border-slate-100 hover:bg-slate-50";

                    html += `
                        <div class="flex justify-between items-center px-2 h-6 rounded border ${bgClass} text-xs transition-colors shadow-sm">
                            <span class="text-slate-600 truncate max-w-[80px]">${name}</span>
                            <span class="${hoursClass}">${hours}h</span>
                        </div>
                    `;
                }
            });
            html += `</div>`;
            return html;
        }

        function renderCalendar() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (window.isFirebaseLoaded === false && window.hasFirebaseConfig) {
                if (loadingOverlay) loadingOverlay.classList.remove('hidden');
            } else {
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
            }

            const container = document.getElementById('calendar');
            const gridHeader = document.getElementById('gridHeader');
            const scrollHint = document.getElementById('scrollHint');
            container.innerHTML = '';

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);

            if (viewMode === 'CALENDAR') {
                container.className = 'calendar-grid';
                gridHeader.classList.remove('hidden');
                scrollHint.classList.add('hidden');

                for (let i = 0; i < firstDay.getDay(); i++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-day bg-slate-100/50';
                    container.appendChild(cell);
                }

                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    const dayOfWeek = date.getDay();
                    const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
                    const shifts = getShiftForDate(date);
                    const holidayName = getHolidayName(dateStr);

                    const cell = document.createElement('div');
                    cell.className = 'calendar-day p-1.5 flex flex-col relative border-t border-r border-slate-100';

                    let numClass = "text-xs font-bold mb-0.5 ";
                    let isRedDay = dayOfWeek === 0 || holidayName;

                    if (isRedDay) numClass += "text-rose-500";
                    else if (dayOfWeek === 6) numClass += "text-blue-500";
                    else numClass += "text-slate-700";

                    let holidayBadge = holidayName
                        ? `<div class="text-[9px] text-rose-500 font-medium truncate mb-0.5">${holidayName}</div>`
                        : `<div class="h-3 mb-0.5"></div>`;

                    cell.innerHTML = `
                        <div class="flex justify-between items-start">
                            <span class="${numClass}">${d}</span>
                        </div>
                        ${holidayBadge}
                        <div class="flex-1 flex flex-col justify-center gap-1">
                            ${generateCompactShiftHtml(shifts)}
                        </div>
                    `;
                    container.appendChild(cell);
                }

            } else {
                container.className = 'horizontal-scroll-container bg-slate-100/50';
                gridHeader.classList.add('hidden');
                scrollHint.classList.remove('hidden');

                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(currentYear, currentMonth, d);
                    const dayOfWeek = date.getDay();
                    const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
                    const shifts = getShiftForDate(date);
                    const holidayName = getHolidayName(dateStr);

                    const card = document.createElement('div');

                    let dateColor = "text-slate-700";
                    let bgColor = "bg-white";

                    let isRedDay = dayOfWeek === 0 || holidayName;

                    if (isRedDay) { dateColor = "text-rose-600"; bgColor = "bg-rose-50/30"; }
                    else if (dayOfWeek === 6) { dateColor = "text-blue-600"; bgColor = "bg-blue-50/30"; }

                    const header = document.createElement('div');
                    header.className = `p-2 border-b border-slate-100 flex justify-between items-center ${bgColor} date-box`;

                    let dateDisplay = `<div class="flex flex-col"><div class="font-bold ${dateColor} text-sm">${(currentMonth + 1)}.${d} <span class="text-[10px] font-normal text-slate-400 ml-0.5">(${DAY_NAMES[dayOfWeek]})</span></div>`;
                    if (holidayName) dateDisplay += `<div class="text-[9px] text-rose-500 font-bold mt-0.5">${holidayName}</div>`;
                    dateDisplay += `</div>`;

                    if (viewMode === 'DETAIL') {
                        card.className = `detail-card`;
                        header.innerHTML = dateDisplay;
                    } else {
                        const myShift = shifts[currentTeam];
                        card.className = `day-card`;
                        header.innerHTML = `
                            ${dateDisplay}
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold ${myShift.badge} shadow-sm self-start mt-0.5">${myShift.label}</span>
                        `;
                    }
                    card.appendChild(header);

                    const body = document.createElement('div');
                    body.className = "p-2 flex-1 flex flex-col space-y-2 bg-white";

                    const teamsToRender = viewMode === 'DETAIL' ? ['A', 'B', 'C', 'DAY_ONLY'] : [currentTeam];

                    teamsToRender.forEach(targetTeam => {
                        const targetShift = shifts[targetTeam];
                        const teamLabel = targetTeam === 'DAY_ONLY' ? 'ì£¼ê°„' : targetTeam + 'ì¡°';

                        const memberCount = window.TEAM_MEMBERS[targetTeam] ? window.TEAM_MEMBERS[targetTeam].length : 7;

                        if (viewMode === 'DETAIL') {
                            const sectionContainer = document.createElement('div');
                            const sectionHeader = `
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">${teamLabel}</span>
                                    <span class="px-1 py-0.5 rounded text-[9px] font-bold ${targetShift.badge}">${targetShift.label}</span>
                                </div>
                            `;
                            sectionContainer.innerHTML = sectionHeader;

                            const groupContainer = document.createElement('div');
                            groupContainer.className = "space-y-1 pl-1 border-l-2 border-slate-100";

                            for (let i = 0; i < memberCount; i++) {
                                const inputVal = getMemo(dateStr, i, targetTeam);
                                const otVal = getMemoOT(dateStr, i, targetTeam);
                                const typeVal = getMemoType(dateStr, i, targetTeam);
                                const wrapper = createInputWrapper(dateStr, i, targetTeam, inputVal, otVal, typeVal, teamLabel);
                                groupContainer.appendChild(wrapper);
                            }
                            sectionContainer.appendChild(groupContainer);
                            body.appendChild(sectionContainer);
                        } else {
                            const groupContainer = document.createElement('div');
                            groupContainer.className = "space-y-1";
                            for (let i = 0; i < memberCount; i++) {
                                const inputVal = getMemo(dateStr, i, targetTeam);
                                const otVal = getMemoOT(dateStr, i, targetTeam);
                                const typeVal = getMemoType(dateStr, i, targetTeam);
                                const wrapper = createInputWrapper(dateStr, i, targetTeam, inputVal, otVal, typeVal, teamLabel);
                                groupContainer.appendChild(wrapper);
                            }
                            body.appendChild(groupContainer);
                        }
                    });

                    card.appendChild(body);
                    container.appendChild(card);

                    if (dayOfWeek === 0) {
                        const summary = document.createElement('div');
                        summary.className = "summary-card summary-container";
                        summary.dataset.sunday = dateStr;

                        summary.innerHTML = `
                            <div class="bg-slate-800 text-white p-2 text-center date-box flex flex-col justify-center">
                                <div class="text-[10px] font-medium text-slate-400 uppercase tracking-widest mb-0.5">Weekly Report</div>
                                <div class="text-sm font-bold">${date.getMonth() + 1}ì›” ${Math.ceil(date.getDate() / 7)}ì£¼ì°¨</div>
                            </div>
                            <div class="flex-1 p-2 summary-content bg-slate-50/50">
                                <!-- Filled by updateAllSummaries -->
                            </div>
                        `;
                        container.appendChild(summary);
                    }
                }

                updateAllSummaries();
            }
        }

        function createInputWrapper(dateStr, i, targetTeam, inputVal, otVal, typeVal, teamLabel) {
            const wrapper = document.createElement('div');
            wrapper.className = "flex gap-1 group items-center";

            // Name Input
            const input = document.createElement('input');
            input.type = "text";
            input.className = "flex-1 min-w-0 text-xs h-6 bg-slate-50 border-0 rounded px-2 text-slate-700 placeholder-slate-400 focus:bg-white focus:ring-1 focus:ring-indigo-500/20 transition-all shadow-sm group-hover:bg-white";
            input.placeholder = `${teamLabel} ${i + 1}`;
            input.value = inputVal;
            input.addEventListener('input', (e) => saveMemo(dateStr, i, e.target.value, targetTeam));

            // Attendance Type Select
            const typeSelect = document.createElement('select');
            let selectClass = "w-10 text-[9px] h-6 bg-slate-50 border-0 rounded px-0 text-center cursor-pointer focus:ring-1 focus:ring-indigo-500/20 shadow-sm appearance-none group-hover:bg-white tracking-tighter";

            const selectedOption = ATTENDANCE_OPTIONS.find(opt => opt.value === typeVal);
            if (selectedOption) {
                selectClass += ` ${selectedOption.color}`;
            } else {
                selectClass += ` text-slate-500`;
            }

            typeSelect.className = selectClass;

            ATTENDANCE_OPTIONS.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.label;
                if (opt.value === typeVal) option.selected = true;
                typeSelect.appendChild(option);
            });

            typeSelect.addEventListener('change', (e) => saveMemoType(dateStr, i, e.target.value, targetTeam));

            // OT Input
            const otInput = document.createElement('input');
            otInput.type = "number";
            otInput.step = "0.5";
            otInput.className = "w-9 text-xs h-6 text-center bg-slate-50 border-0 rounded px-0 text-slate-600 font-medium placeholder-slate-400 focus:bg-white focus:ring-1 focus:ring-indigo-500/20 transition-all shadow-sm group-hover:bg-white";
            otInput.placeholder = "OT";
            otInput.value = otVal;
            otInput.addEventListener('input', (e) => saveMemoOT(dateStr, i, e.target.value, targetTeam));

            wrapper.appendChild(input);
            wrapper.appendChild(typeSelect);
            wrapper.appendChild(otInput);
            return wrapper;
        }

        function generateCompactShiftHtml(shifts) {
            let html = '';
            const renderItem = (team, type) => {
                if (team === 'DAY_ONLY') return '';
                return `
                <div class="flex items-center justify-between px-1.5 py-0.5 rounded text-[9px] ${type.badge} border border-transparent">
                    <span class="font-bold opacity-80">${type.label}</span>
                    <span class="font-bold">${team}</span>
                </div>`;
            };

            for (const [team, type] of Object.entries(shifts)) {
                if (type === window.SHIFT_TYPES.DAY) html += renderItem(team, type);
            }
            for (const [team, type] of Object.entries(shifts)) {
                if (type === window.SHIFT_TYPES.NIGHT) html += renderItem(team, type);
            }
            for (const [team, type] of Object.entries(shifts)) {
                if (type === window.SHIFT_TYPES.JU_HYU || type === window.SHIFT_TYPES.MU_HYU || type === window.SHIFT_TYPES.YU_HYU) html += renderItem(team, type);
            }
            return html;
        }

        function downloadAllData() {
            const data = {
                roster: window.rosterData,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `roster-backup-${dateStr}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        init();

        setTimeout(() => {
            if (window.isFirebaseLoaded === false && window.hasFirebaseConfig) {
                console.log("Loading timed out. Forcing offline mode.");
                window.isFirebaseLoaded = true;
                if (window.renderCalendar) window.renderCalendar();
            }
        }, 3000);
    </script>
</body>

</html>